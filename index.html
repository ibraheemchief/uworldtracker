<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWorld Tracker - Multi-User</title>
    <style>
        :root {
            --bg: #0f1113;
            --card: #1c1f22;
            --text: #e8e9eb;
            --accent: #3d85c6;
            --success: #6aa84f;
            --milestone: #f1c232;
            --danger: #dc3545;
            --today-bg: rgba(241, 194, 50, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        h2 {
            font-size: 1.3rem;
        }

        h3 {
            font-size: 1.1rem;
        }

        @media (min-width: 768px) {
            h2 {
                font-size: 1.8rem;
            }

            h3 {
                font-size: 1.3rem;
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 0;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 100%;
            padding: 5px;
        }

        @media (min-width: 768px) {
            .container {
                padding: 20px;
            }
        }

        /* Auth Screen */
        #auth-screen {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
        }

        .auth-card {
            background: var(--card);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid #333;
        }

        .auth-card h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .auth-card p {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            background: #25292d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 1rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover { background: #2d6ba8; }

        .btn-secondary {
            background: #333;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover { background: #444; }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover { background: #c82333; }

        .text-center { text-align: center; }
        .mt-3 { margin-top: 20px; }
        .text-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
        }

        .text-link:hover { text-decoration: underline; }

        .error-msg {
            background: rgba(220, 53, 69, 0.2);
            color: #ff6b7a;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        /* Main App */
        #app-screen { display: none; }
        #app-screen.active { display: block; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--card);
            border-radius: 8px;
            border: 1px solid #333;
        }

        @media (min-width: 768px) {
            .header {
                padding: 20px;
                margin-bottom: 25px;
                border-radius: 12px;
            }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 8px 14px;
            background: var(--card);
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        @media (min-width: 768px) {
            .tabs {
                gap: 10px;
                margin-bottom: 25px;
            }

            .tab {
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 1rem;
            }
        }

        .tab.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 25px;
            }
        }

        .stat-box {
            background: var(--card);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
        }

        @media (min-width: 768px) {
            .stat-box {
                padding: 18px;
                border-radius: 10px;
            }
        }

        .stat-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent);
        }

        @media (min-width: 768px) {
            .stat-label {
                font-size: 0.85rem;
                margin-bottom: 8px;
            }

            .stat-value {
                font-size: 1.6rem;
            }
        }

        .stat-value.success { color: var(--success); }
        .stat-value.milestone { color: var(--milestone); }

        .stats-card {
            background: var(--card);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #333;
        }

        @media (min-width: 768px) {
            .stats-card {
                padding: 25px;
                border-radius: 12px;
                margin-bottom: 25px;
            }
        }

        .progress-container {
            position: relative;
            height: 30px;
            background: #333;
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.5s ease;
        }

        .milestone-marker {
            position: absolute;
            top: 0;
            left: 51.25%;
            width: 3px;
            height: 100%;
            background: var(--milestone);
            z-index: 2;
            box-shadow: 0 0 10px var(--milestone);
        }

        .label-container {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-controls { display: flex; gap: 10px; align-items: center; }

        .nav-btn {
            background: #333;
            color: white;
            border: 1px solid #444;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        @media (min-width: 768px) {
            .nav-btn {
                padding: 8px 14px;
                font-size: 0.95rem;
            }
        }

        .nav-btn:hover { background: #444; }
        .today-btn { background: var(--accent) !important; border: none !important; }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--card);
            padding: 2px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .calendar-grid {
                gap: 12px;
                padding: 25px;
                border-radius: 12px;
            }
        }

        .weekday {
            text-align: center;
            color: #666;
            font-size: 0.65rem;
            font-weight: bold;
            padding-bottom: 5px;
        }

        @media (min-width: 768px) {
            .weekday {
                font-size: 0.8rem;
                padding-bottom: 8px;
            }
        }

        .day-cell {
            background: #25292d;
            aspect-ratio: 1/1;
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 1px solid #333;
            position: relative;
            transition: all 0.2s;
            min-height: 40px;
            font-size: 0.7rem;
            padding: 1px;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .day-cell {
                min-height: 80px;
                border-radius: 8px;
                font-size: 1rem;
            }
        }

        .day-cell:hover { border-color: var(--accent); }

        .is-today {
            border: 2px solid var(--milestone) !important;
            background: var(--today-bg) !important;
        }

        .is-today::after {
            content: "TODAY";
            position: absolute;
            top: -12px;
            font-size: 0.6rem;
            background: var(--milestone);
            color: black;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .filled { background: #2d3e30; border-color: var(--success); }
        .q-val { font-size: 1.1rem; font-weight: bold; }
        .date-num { font-size: 0.7rem; color: #888; }

        .has-notes::before {
            content: "üìù";
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.7rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--card);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            border: 1px solid #444;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent);
        }

        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .close-btn:hover { color: white; }

        .input-group textarea {
            width: 100%;
            background: #25292d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            align-items: stretch;
            margin-top: 20px;
        }

        .modal-actions .btn {
            width: auto;
            padding: 10px 20px;
            margin-top: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Friends & Leaderboard */
        #friends-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        #leaderboard-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        #friend-requests {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            #friends-list {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            #leaderboard-list {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            #friend-requests {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }

        @media (min-width: 1200px) {
            #friends-list {
                grid-template-columns: repeat(3, 1fr);
            }

            #leaderboard-list {
                grid-template-columns: repeat(3, 1fr);
            }

            #friend-requests {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1600px) {
            #friends-list {
                grid-template-columns: repeat(4, 1fr);
            }

            #leaderboard-list {
                grid-template-columns: repeat(4, 1fr);
            }

            #friend-requests {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .friend-item, .leaderboard-item {
            background: var(--card);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        @media (min-width: 768px) {
            .friend-item, .leaderboard-item {
                padding: 20px;
            }
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .friend-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
            width: 100%;
        }

        .friend-actions .btn-small {
            flex: 1;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            width: auto;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #888;
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 2px dashed #333;
            font-size: 0.95rem;
        }

        @media (min-width: 768px) {
            .empty-state {
                padding: 40px;
                font-size: 1rem;
            }
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            max-width: 100%;
        }

        @media (min-width: 768px) {
            .search-box input {
                max-width: 500px;
            }
        }

        .rank {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--milestone);
            margin-bottom: 8px;
        }

        .progress-mini {
            font-size: 0.9rem;
            color: #888;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen">
    <div class="auth-card">
        <h1>üéØ UWorld Tracker</h1>
        <p>Track your progress together</p>

        <div id="error-display"></div>

        <div id="login-form">
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="login-email" placeholder="your@email.com">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary" onclick="login()">Sign In</button>
            <p class="text-center mt-3">
                Don't have an account?
                <a class="text-link" onclick="toggleAuthMode()">Sign Up</a>
            </p>
        </div>

        <div id="signup-form" style="display: none;">
            <div class="input-group">
                <label>Display Name</label>
                <input type="text" id="signup-name" placeholder="John Doe">
            </div>
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="signup-email" placeholder="your@email.com">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary" onclick="signup()">Create Account</button>
            <p class="text-center mt-3">
                Already have an account?
                <a class="text-link" onclick="toggleAuthMode()">Sign In</a>
            </p>
        </div>
    </div>
</div>

<!-- Main App Screen -->
<div id="app-screen">
    <div class="container">
        <div class="header">
            <div class="user-info">
                <div class="avatar" id="user-avatar">U</div>
                <div>
                    <div id="user-name" style="font-weight: bold;">User</div>
                    <div id="user-email" style="font-size: 0.85rem; color: #888;"></div>
                </div>
            </div>
            <button class="btn btn-secondary btn-small" onclick="logout()">Sign Out</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('tracker')">My Tracker</div>
            <div class="tab" onclick="switchTab('friends')">Friends</div>
            <div class="tab" onclick="switchTab('leaderboard')">Leaderboard</div>
        </div>

        <!-- Tracker Tab -->
        <div id="tracker-tab" class="tab-content active">
            <!-- Viewing Friend Banner -->
            <div id="viewing-banner" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 8px;">
                    üëÅÔ∏è Viewing <span id="viewing-name"></span>'s Progress
                </div>
                <button class="btn btn-secondary btn-small" onclick="returnToMyProgress()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                    ‚Üê Back to My Progress
                </button>
            </div>

            <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="stat-box">
                    <div class="stat-label">Questions Remaining</div>
                    <div class="stat-value" id="stat-remaining">4088</div>
                </div>
                <div class="stat-box" id="anki-box">
                    <div class="stat-label" id="anki-label">Did you solve Anki today?</div>
                    <div style="margin-top: 8px;">
                        <label style="cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.1rem;">
                            <input type="checkbox" id="anki-checkbox" onchange="toggleAnki()" style="width: 22px; height: 22px; cursor: pointer; accent-color: #4CAF50; pointer-events: auto;">
                            <span id="anki-status" style="color: #aaa;">Not yet</span>
                        </label>
                    </div>
                </div>
                <div class="stat-box" id="friend-watch-box">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="font-weight: bold; font-size: 0.85rem;">Watching üëÄü©¥</span>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <select id="friend-watch-select" onchange="selectWatchFriend()" style="background: #1a1a2e; color: #fff; border: 1px solid #333; border-radius: 4px; padding: 3px 5px; font-size: 0.75rem; cursor: pointer; max-width: 110px;">
                                <option value="">-- Select --</option>
                            </select>
                            <button onclick="clearWatchFriend()" style="background: none; border: 1px solid #555; color: #aaa; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.7rem;">‚úï</button>
                        </div>
                    </div>
                    <div id="friend-watch-content" style="color: #888; font-size: 0.8rem;">
                        Select a friend
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <div class="label-container">
                    <span>Overall Progress</span>
                    <span><span id="total-val">0</span> / 4088 Qs</span>
                </div>
                <div class="progress-container">
                    <div id="progress-fill"></div>
                    <div class="milestone-marker" title="Milestone: 2095"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #aaa;">
                    <span>Start</span>
                    <span style="color: var(--milestone);">60% Milestone (2095)</span>
                    <span>Finish (4088)</span>
                </div>
            </div>

            <div class="nav-header">
                <div class="nav-controls">
                    <button class="nav-btn" onclick="changeMonth(-1)">Prev</button>
                    <button class="nav-btn today-btn" onclick="goToToday()">Today</button>
                    <button class="nav-btn" onclick="changeMonth(1)">Next</button>
                </div>
                <h2 id="month-label" style="margin: 0;">Month 2026</h2>
            </div>

            <div class="calendar-grid" id="calendar">
                <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
                <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
            </div>
        </div>

        <!-- Friends Tab -->
        <div id="friends-tab" class="tab-content">
            <div class="search-box">
                <div class="input-group">
                    <label>Add Friend by Email</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="email" id="friend-email" placeholder="friend@email.com" style="flex: 1;">
                        <button class="btn btn-primary btn-small" onclick="sendFriendRequest()">Send Request</button>
                    </div>
                </div>
            </div>

            <div class="stats-card" style="margin-top: 25px;">
                <h3 style="margin-bottom: 15px;">üì¨ Friend Requests</h3>
                <div id="friend-requests"></div>
            </div>

            <div class="stats-card">
                <h3 style="margin-bottom: 15px;">üë• My Friends</h3>
                <div id="friends-list"></div>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboard-tab" class="tab-content">
            <div class="stats-card">
                <h2 style="margin-bottom: 20px;">üèÜ Friends Leaderboard</h2>
                <div id="leaderboard-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Day Entry Modal -->
<div class="modal-overlay" id="day-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modal-title">Edit Day</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="input-group">
            <label>Questions / Progress (up to 20 characters)</label>
            <input type="text" id="questions-input" placeholder="e.g., 50 or UW Block 1" maxlength="20">
        </div>
        <div class="input-group">
            <label>Notes (Optional)</label>
            <textarea id="notes-input" placeholder="Topics covered, mistakes, insights..."></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn btn-danger btn-small" id="delete-btn" onclick="deleteEntry()">Delete</button>
            <button class="btn btn-secondary btn-small" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary btn-small" onclick="saveEntry()">Save</button>
        </div>
    </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js?v=3"></script>

<script>
// Initialize Supabase
var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentViewDate = new Date();
const realToday = new Date();
let currentEditKey = null;
let userProgress = {};
let myProgressCache = {}; // Cache of current user's progress for instant switching
let friendsData = {};
let viewingFriendId = null;
let viewingFriendName = null;

// Auth State Observer
supabase.auth.onAuthStateChange((event, session) => {
    if (session?.user) {
        currentUser = session.user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').classList.add('active');
        initializeApp();
    } else {
        currentUser = null;
        document.getElementById('auth-screen').style.display = 'block';
        document.getElementById('app-screen').classList.remove('active');
    }
});

async function initializeApp() {
    // Get user metadata
    let { data: userData } = await supabase
        .from('users')
        .select('name')
        .eq('id', currentUser.id)
        .single();

    // If user doesn't exist in users table, create it
    if (!userData) {
        const defaultName = currentUser.email?.split('@')[0] || 'User';
        await supabase.from('users').insert({
            id: currentUser.id,
            name: defaultName,
            email: currentUser.email.toLowerCase()
        });
        userData = { name: defaultName };
    }

    const displayName = userData?.name || currentUser.email?.split('@')[0] || 'User';

    document.getElementById('user-name').textContent = displayName;
    document.getElementById('user-email').textContent = currentUser.email;
    document.getElementById('user-avatar').textContent = displayName[0].toUpperCase();

    // Load user's progress and friends in parallel
    const [_] = await Promise.all([
        loadProgress(),
        loadFriends(),
        loadFriendRequests()
    ]);

    render();
    updateStats();
    loadAnkiState();

    // Restore previous state (tab and viewing friend)
    await restoreState();
}

async function restoreState() {
    // Restore viewing friend if there was one
    const savedFriendId = localStorage.getItem('viewingFriendId');
    const savedFriendName = localStorage.getItem('viewingFriendName');

    if (savedFriendId && savedFriendName) {
        console.log('Restoring friend view:', savedFriendName);
        viewingFriendId = savedFriendId;
        viewingFriendName = savedFriendName;

        document.getElementById('viewing-banner').style.display = 'block';
        document.getElementById('viewing-name').textContent = savedFriendName;

        await loadProgress();
        render();
        updateStats();
        loadAnkiState();
    }

    // Restore last active tab
    const savedTab = localStorage.getItem('lastActiveTab');

    if (savedTab && savedTab !== 'tracker') {
        console.log('Restoring tab:', savedTab);

        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

        // Activate saved tab
        const tabButtons = document.querySelectorAll('.tab');
        tabButtons.forEach(btn => {
            if (btn.textContent.toLowerCase().includes(savedTab)) {
                btn.classList.add('active');
            }
        });

        document.getElementById(savedTab + '-tab').classList.add('active');

        // Load tab data
        if (savedTab === 'friends') {
            loadFriendRequests();
            loadFriends();
        } else if (savedTab === 'leaderboard') {
            loadLeaderboard();
        }
    }
}

function toggleAuthMode() {
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
    } else {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
    }
    document.getElementById('error-display').innerHTML = '';
}

async function login() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
    } catch (error) {
        showError(error.message);
    }
}

async function signup() {
    const name = document.getElementById('signup-name').value.trim();
    const email = document.getElementById('signup-email').value.trim().toLowerCase();
    const password = document.getElementById('signup-password').value;

    if (!name || !email || !password) {
        showError('Please fill in all fields');
        return;
    }

    try {
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) throw error;

        if (data.user) {
            // Create user profile
            const { error: insertError } = await supabase.from('users').insert({
                id: data.user.id,
                name: name,
                email: email
            });

            if (insertError) throw insertError;

            // Clear signup form
            document.getElementById('signup-name').value = '';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-password').value = '';

            // Switch to login
            toggleAuthMode();

            // Show success message on login form
            document.getElementById('error-display').innerHTML =
                '<div style="background: rgba(106, 168, 79, 0.2); color: #6aa84f; padding: 10px; border-radius: 6px; margin-bottom: 15px;">Account created successfully! Please log in.</div>';
        }
    } catch (error) {
        showError(error.message);
    }
}

async function logout() {
    await supabase.auth.signOut();
}

function showError(message) {
    document.getElementById('error-display').innerHTML =
        `<div class="error-msg">${message}</div>`;
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

    // Find and activate the correct tab button
    const tabButtons = document.querySelectorAll('.tab');
    tabButtons.forEach(btn => {
        const btnText = btn.textContent.trim().toLowerCase();
        const tabMatch = (tab === 'tracker' && btnText.includes('tracker')) ||
                        (tab === 'friends' && btnText === 'friends') ||
                        (tab === 'leaderboard' && btnText === 'leaderboard');
        if (tabMatch) {
            btn.classList.add('active');
        }
    });

    document.getElementById(tab + '-tab').classList.add('active');

    // Save current tab to localStorage
    localStorage.setItem('lastActiveTab', tab);

    if (tab === 'friends') {
        console.log('üîÑ Switching to Friends tab - reloading fresh data...');
        // Always reload to get latest friend data
        loadFriendRequests();
        loadFriends();
    } else if (tab === 'leaderboard') {
        loadLeaderboard();
    } else if (tab === 'tracker') {
        // Refresh tracker data when switching back
        if (!viewingFriendId) {
            render();
            updateStats();
        }
    }
}

// Progress Functions
async function loadProgress() {
    // Load progress for the user we're viewing (or current user)
    const userId = viewingFriendId || currentUser.id;
    const isMyProgress = !viewingFriendId;

    console.log('Loading progress for user:', userId, isMyProgress ? '(my progress)' : '(viewing friend)');

    const { data, error } = await supabase
        .from('progress')
        .select('*')
        .eq('user_id', userId);

    userProgress = {};
    if (data) {
        data.forEach(entry => {
            userProgress[entry.date_key] = {
                questions: entry.questions,
                notes: entry.notes
            };
        });
    }

    // Cache current user's progress for instant switching
    if (isMyProgress) {
        myProgressCache = { ...userProgress };
        console.log('Cached my progress');
    }
}

async function saveProgressEntry(dateKey, questions, notes) {
    const { error } = await supabase
        .from('progress')
        .upsert({
            user_id: currentUser.id,
            date_key: dateKey,
            questions: questions || null,
            notes: notes || null
        }, {
            onConflict: 'user_id,date_key'
        });
    if (error) {
        console.error('Save error:', error);
    }
}

async function deleteProgressEntry(dateKey) {
    await supabase
        .from('progress')
        .delete()
        .eq('user_id', currentUser.id)
        .eq('date_key', dateKey);
}

function render() {
    const cal = document.getElementById('calendar');
    while(cal.children.length > 7) cal.removeChild(cal.lastChild);

    const year = currentViewDate.getFullYear();
    const month = currentViewDate.getMonth();
    document.getElementById('month-label').innerText =
        currentViewDate.toLocaleString('default', { month: 'long', year: 'numeric' });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) cal.appendChild(document.createElement('div'));

    for (let d = 1; d <= daysInMonth; d++) {
        const key = `${year}-${month}-${d}`;
        const cell = document.createElement('div');
        cell.className = 'day-cell';

        if (year === realToday.getFullYear() &&
            month === realToday.getMonth() &&
            d === realToday.getDate()) {
            cell.classList.add('is-today');
        }

        const entry = userProgress[key];
        // Handle 0, empty string, null, undefined properly
        const questions = entry?.questions !== undefined && entry?.questions !== null && entry?.questions !== '' ? entry.questions : "";
        const notes = entry?.notes || "";

        // Show as filled if there's any value (including 0 or text)
        if (questions !== "" && questions !== "-") {
            cell.classList.add('filled');
        }

        if (notes && notes.trim()) {
            cell.classList.add('has-notes');
        }

        // Display the value (including 0 and text), or "‚Äî" if empty
        const displayValue = questions !== "" ? questions : "‚Äî";

        // Add note icon if viewing friend and they have notes
        const noteIcon = (viewingFriendId && notes && notes.trim()) ? '<div style="position: absolute; top: 2px; right: 2px; font-size: 0.7rem;">üìù</div>' : '';

        cell.innerHTML = `
            ${noteIcon}
            <div class="date-num">${d}</div>
            <div class="q-val">${displayValue}</div>
        `;

        // Handle click based on viewing mode
        if (!viewingFriendId) {
            // Editing own progress
            cell.onclick = () => openModal(key, d);
        } else if (notes && notes.trim()) {
            // Viewing friend's notes
            cell.onclick = () => {
                alert(`üìù ${viewingFriendName}'s Note (${currentViewDate.toLocaleString('default', {month:'long'})} ${d}):\n\n${notes}`);
            };
            cell.style.cursor = 'pointer';
        } else {
            cell.style.cursor = 'default';
        }

        cal.appendChild(cell);
    }
    updateStats();
}

function openModal(key, day) {
    // Don't allow editing when viewing friend's progress
    if (viewingFriendId) {
        alert('You cannot edit ' + viewingFriendName + "'s progress. Click 'Back to My Progress' to edit your own.");
        return;
    }

    currentEditKey = key;
    const entry = userProgress[key] || { questions: '', notes: '' };

    document.getElementById('modal-title').innerText =
        `${currentViewDate.toLocaleString('default', {month:'long'})} ${day}, ${currentViewDate.getFullYear()}`;
    document.getElementById('questions-input').value = entry.questions || '';
    document.getElementById('notes-input').value = entry.notes || '';
    document.getElementById('day-modal').classList.add('active');
    document.getElementById('questions-input').focus();

    const hasData = entry.questions || entry.notes;
    document.getElementById('delete-btn').style.display = hasData ? 'inline-block' : 'none';
}

function closeModal() {
    document.getElementById('day-modal').classList.remove('active');
    currentEditKey = null;
}

async function saveEntry() {
    if (!currentEditKey) return;

    const questions = document.getElementById('questions-input').value.trim();
    const notes = document.getElementById('notes-input').value.trim();

    if (questions || notes) {
        userProgress[currentEditKey] = { questions, notes };
        await saveProgressEntry(currentEditKey, questions, notes);
    } else {
        delete userProgress[currentEditKey];
        await deleteProgressEntry(currentEditKey);
    }

    closeModal();
    render();
}

async function deleteEntry() {
    if (!currentEditKey) return;

    if (confirm('Delete this entry?')) {
        delete userProgress[currentEditKey];
        await deleteProgressEntry(currentEditKey);
        closeModal();
        render();
    }
}

async function toggleAnki() {
    if (viewingFriendId) return; // Can't change friend's Anki

    const checkbox = document.getElementById('anki-checkbox');
    const status = document.getElementById('anki-status');
    const label = document.getElementById('anki-label');
    const today = new Date();
    const ankiKey = `anki-${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;

    if (checkbox.checked) {
        // Save to Supabase - use -1 as marker for anki done
        const { error } = await supabase
            .from('progress')
            .upsert({
                user_id: currentUser.id,
                date_key: ankiKey,
                questions: '-1',
                notes: 'anki'
            }, { onConflict: 'user_id,date_key' });

        if (error) {
            console.error('Anki save error:', error);
            checkbox.checked = false;
            alert('Anki save failed: ' + error.message);
            return;
        }

        userProgress[ankiKey] = { questions: '-1', notes: 'anki' };
        status.textContent = 'Anki is done!';
        status.style.color = '#4CAF50';
        label.textContent = 'Anki Today';
    } else {
        await deleteProgressEntry(ankiKey);
        delete userProgress[ankiKey];
        status.textContent = 'Not yet';
        status.style.color = '#aaa';
        label.textContent = 'Did you solve Anki today?';
    }
}

function loadAnkiState() {
    const today = new Date();
    const ankiKey = `anki-${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
    const checkbox = document.getElementById('anki-checkbox');
    const status = document.getElementById('anki-status');
    const label = document.getElementById('anki-label');

    const ankiEntry = userProgress[ankiKey];
    const ankiDone = ankiEntry && ankiEntry.notes === 'anki';

    if (viewingFriendId) {
        // Viewing friend - show THEIR status, disable checkbox
        checkbox.disabled = true;
        checkbox.style.cursor = 'not-allowed';
        label.textContent = viewingFriendName + "'s Anki Today";
        if (ankiDone) {
            checkbox.checked = true;
            status.textContent = 'Anki is done!';
            status.style.color = '#4CAF50';
        } else {
            checkbox.checked = false;
            status.textContent = 'Not yet';
            status.style.color = '#f44336';
        }
    } else {
        // Viewing own - enable checkbox
        checkbox.disabled = false;
        checkbox.style.cursor = 'pointer';
        label.textContent = ankiDone ? 'Anki Today' : 'Did you solve Anki today?';
        if (ankiDone) {
            checkbox.checked = true;
            status.textContent = 'Anki is done!';
            status.style.color = '#4CAF50';
        } else {
            checkbox.checked = false;
            status.textContent = 'Not yet';
            status.style.color = '#aaa';
        }
    }
}

// Friend Watch Functions
async function selectWatchFriend() {
    const select = document.getElementById('friend-watch-select');
    const friendId = select.value;
    const friendName = select.options[select.selectedIndex]?.text || '';

    if (!friendId) {
        clearWatchFriend();
        return;
    }

    // Save selection to localStorage
    localStorage.setItem('watchFriendId', friendId);
    localStorage.setItem('watchFriendName', friendName);

    await loadWatchFriendData(friendId, friendName);
}

async function loadWatchFriendData(friendId, friendName) {
    const content = document.getElementById('friend-watch-content');
    content.innerHTML = '<span style="color: #888;">Loading...</span>';

    const today = new Date();
    const todayKey = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
    const ankiKey = `anki-${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;

    // Fetch friend's today progress and anki status
    const { data } = await supabase
        .from('progress')
        .select('date_key, questions, notes')
        .eq('user_id', friendId)
        .in('date_key', [todayKey, ankiKey]);

    let todayEntry = null;
    let ankiDone = false;

    if (data) {
        data.forEach(entry => {
            if (entry.date_key === todayKey) todayEntry = entry;
            if (entry.date_key === ankiKey && entry.notes === 'anki') ankiDone = true;
        });
    }

    const metric = todayEntry?.questions || '‚Äî';
    const note = todayEntry?.notes || '';
    const ankiText = ankiDone
        ? '<span style="color: #4CAF50;">&#10003; Anki done</span>'
        : '<span style="color: #f44336;">&#10007; Anki not done</span>';

    content.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 6px; text-align: left;">
            <div style="font-weight: bold; color: #667eea; font-size: 1rem; margin-bottom: 2px;">${friendName}</div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div><span style="color: #aaa;">Today's Qs:</span> <span style="color: #fff; font-weight: bold;">${metric}</span></div>
                <div>${ankiText}</div>
            </div>
            ${note ? `<div style="color: #ccc; font-size: 0.85rem; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 6px; margin-top: 2px;">&#128221; ${note}</div>` : '<div style="color: #666; font-size: 0.85rem;">No note today</div>'}
        </div>
    `;
}

function clearWatchFriend() {
    localStorage.removeItem('watchFriendId');
    localStorage.removeItem('watchFriendName');
    document.getElementById('friend-watch-select').value = '';
    document.getElementById('friend-watch-content').innerHTML = '<span style="color: #888;">Select a friend</span>';
}

function populateFriendWatchDropdown(friendsList) {
    const select = document.getElementById('friend-watch-select');
    const savedId = localStorage.getItem('watchFriendId');

    // Keep the first option, remove the rest
    select.innerHTML = '<option value="">-- Select a friend --</option>';

    friendsList.forEach(f => {
        const option = document.createElement('option');
        option.value = f.id;
        option.textContent = f.name;
        if (f.id === savedId) option.selected = true;
        select.appendChild(option);
    });

    // If there was a saved friend, load their data
    if (savedId) {
        const savedName = localStorage.getItem('watchFriendName') || '';
        loadWatchFriendData(savedId, savedName);
    }
}

function changeMonth(dir) {
    currentViewDate.setMonth(currentViewDate.getMonth() + dir);
    render();
}

function goToToday() {
    currentViewDate = new Date();
    render();
}

function updateStats() {
    const TOTAL_GOAL = 4088;
    let total = 0;
    let bestDay = 0;
    let daysWithData = 0;

    Object.entries(userProgress).forEach(([key, entry]) => {
        if (key.startsWith('anki-') || entry?.notes === 'anki') return; // Skip anki entries
        const questions = entry?.questions;
        if (questions !== undefined && questions !== null && questions !== '') {
            // Try to parse as number
            const q = parseInt(questions);
            if (!isNaN(q)) {
                // It's a number - add to totals
                total += q;
                daysWithData++;
                if (q > bestDay) bestDay = q;
            } else {
                // It's text - just count as a day with data
                daysWithData++;
            }
        }
    });

    let streak = 0;
    const today = new Date(realToday);
    today.setHours(0, 0, 0, 0);

    for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const key = `${checkDate.getFullYear()}-${checkDate.getMonth()}-${checkDate.getDate()}`;
        const entry = userProgress[key];
        const questions = entry?.questions;

        // Count as active day if there's any value (number or text)
        if (questions !== undefined && questions !== null && questions !== '') {
            streak++;
        } else if (i > 0) {
            break;
        }
    }

    document.getElementById('total-val').innerText = total;
    document.getElementById('progress-fill').style.width = (total / TOTAL_GOAL * 100) + "%";
    document.getElementById('stat-remaining').innerText = Math.max(0, TOTAL_GOAL - total);
}

// Friend Functions
async function sendFriendRequest() {
    const email = document.getElementById('friend-email').value.trim().toLowerCase();
    if (!email) {
        alert('Please enter an email address');
        return;
    }

    console.log('Searching for user with email:', email);

    try {
        // Find user by email (case-insensitive)
        const { data: users, error: searchError } = await supabase
            .from('users')
            .select('*')
            .ilike('email', email)
            .limit(1);

        console.log('Search result:', { users, error: searchError });

        if (searchError) {
            console.error('Search error:', searchError);
            alert('Error searching for user: ' + searchError.message);
            return;
        }

        if (!users || users.length === 0) {
            alert('User not found with email: ' + email + '\n\nMake sure they have signed up first!');
            return;
        }

        const friend = users[0];
        console.log('Found friend:', friend);

        if (friend.id === currentUser.id) {
            alert('Cannot add yourself as a friend');
            return;
        }

        // Check if already friends
        const { data: existingFriend } = await supabase
            .from('friends')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('friend_id', friend.id)
            .limit(1);

        if (existingFriend && existingFriend.length > 0) {
            alert('You are already friends with ' + friend.name);
            return;
        }

        // Check if request already exists
        const { data: existingRequest } = await supabase
            .from('friend_requests')
            .select('*')
            .eq('from_user_id', currentUser.id)
            .eq('to_user_id', friend.id)
            .eq('status', 'pending')
            .limit(1);

        if (existingRequest && existingRequest.length > 0) {
            alert('Friend request already sent to ' + friend.name);
            return;
        }

        // Get current user's name
        const { data: currentUserData } = await supabase
            .from('users')
            .select('name')
            .eq('id', currentUser.id)
            .single();

        console.log('Current user data:', currentUserData);

        // Create friend request
        const requestPayload = {
            from_user_id: currentUser.id,
            from_name: currentUserData?.name || 'User',
            to_user_id: friend.id,
            to_name: friend.name,
            status: 'pending'
        };

        console.log('Inserting friend request:', requestPayload);

        const { data: requestData, error: requestError } = await supabase
            .from('friend_requests')
            .insert(requestPayload)
            .select();

        console.log('Insert result:', { requestData, error: requestError });

        if (requestError) {
            console.error('Friend request insert error:', requestError);
            alert('Error sending request: ' + requestError.message + '\n\nCheck browser console for details.');
            return;
        }

        alert('‚úÖ Friend request sent to ' + friend.name + '!\n\nThey will see it when they refresh or check their Friends tab.');
        document.getElementById('friend-email').value = '';
    } catch (error) {
        console.error('Send friend request error:', error);
        alert('Error: ' + error.message + '\n\nCheck browser console (F12) for details.');
    }
}

async function loadFriendRequests() {
    console.log('Loading friend requests for user:', currentUser.id);

    const { data: requests, error } = await supabase
        .from('friend_requests')
        .select('*')
        .eq('to_user_id', currentUser.id)
        .eq('status', 'pending');

    console.log('Friend requests query result:', { requests, error });

    const container = document.getElementById('friend-requests');

    if (error) {
        console.error('Error loading friend requests:', error);
        container.innerHTML = '<div class="empty-state">‚ùå Error loading requests: ' + error.message + '</div>';
        return;
    }

    if (!requests || requests.length === 0) {
        console.log('No pending friend requests');
        container.innerHTML = '<div class="empty-state">üì≠ No pending friend requests</div>';
        return;
    }

    console.log('Found', requests.length, 'friend requests');

    // Build all request cards first, then update DOM once (prevents flickering)
    const requestCards = requests.map(req => `
        <div class="friend-item">
            <div class="friend-info">
                <div class="avatar">${req.from_name[0].toUpperCase()}</div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; font-size: 1.1rem;">${req.from_name}</div>
                    <div style="font-size: 0.9rem; color: #888;">Wants to connect</div>
                </div>
            </div>
            <div class="friend-actions">
                <button class="btn btn-primary btn-small" onclick="acceptFriendRequest('${req.id}', '${req.from_user_id}')">Accept</button>
                <button class="btn btn-secondary btn-small" onclick="rejectFriendRequest('${req.id}')">Decline</button>
            </div>
        </div>
    `);

    // Update DOM once with all cards
    container.innerHTML = requestCards.join('');
}

async function acceptFriendRequest(requestId, friendId) {
    try {
        console.log('Accepting friend request:', requestId, 'from:', friendId);

        // Only insert for current user (RLS policy allows this)
        const { data, error: insertError } = await supabase.from('friends').insert({
            user_id: currentUser.id,
            friend_id: friendId
        });

        if (insertError) {
            console.error('Friend insert error:', insertError);
            throw insertError;
        }

        console.log('Friend added to current user');

        // Delete request
        const { error: deleteError } = await supabase.from('friend_requests').delete().eq('id', requestId);

        if (deleteError) {
            console.error('Delete request error:', deleteError);
        }

        alert('‚úÖ Friend added successfully!');
        loadFriendRequests();
        loadFriends();
    } catch (error) {
        console.error('Accept friend error:', error);
        alert('Error accepting friend request: ' + error.message);
    }
}

async function rejectFriendRequest(requestId) {
    await supabase.from('friend_requests').delete().eq('id', requestId);
    loadFriendRequests();
}

async function loadFriends() {
    console.log('üîÑ Loading friends for user:', currentUser.id);

    // Get friends where current user accepted their request
    const { data: friendships1, error: error1 } = await supabase
        .from('friends')
        .select('*')
        .eq('user_id', currentUser.id);

    console.log('Query 1 (I accepted):', friendships1, error1);

    // Get friends where they accepted current user's request
    const { data: friendships2, error: error2 } = await supabase
        .from('friends')
        .select('*')
        .eq('friend_id', currentUser.id);

    console.log('Query 2 (They accepted):', friendships2, error2);

    const container = document.getElementById('friends-list');

    if (error1 || error2) {
        console.error('Load friends error:', { error1, error2 });
        container.innerHTML = '<div class="empty-state">Error loading friends</div>';
        return;
    }

    // Combine both directions and get unique friend IDs
    const friendIds = new Set();

    if (friendships1) {
        console.log('Adding from friendships1:', friendships1.length);
        friendships1.forEach(f => {
            console.log('  - friend_id:', f.friend_id);
            friendIds.add(f.friend_id);
        });
    }

    if (friendships2) {
        console.log('Adding from friendships2:', friendships2.length);
        friendships2.forEach(f => {
            console.log('  - user_id:', f.user_id);
            friendIds.add(f.user_id);
        });
    }

    console.log('‚úÖ Total unique friend IDs:', Array.from(friendIds));

    if (friendIds.size === 0) {
        container.innerHTML = '<div class="empty-state">üëã No friends yet. Add some above to start tracking together!</div>';
        return;
    }

    // Build all friend cards first, then update DOM once (prevents flickering)
    const friendCards = [];
    const friendsList = [];

    for (const friendId of friendIds) {

        // Get friend data
        const { data: friendData } = await supabase
            .from('users')
            .select('name')
            .eq('id', friendId)
            .single();

        const name = friendData?.name || 'User';
        friendsList.push({ id: friendId, name: name });

        // Get friend's progress (exclude anki entries)
        const { data: progressData } = await supabase
            .from('progress')
            .select('questions, date_key')
            .eq('user_id', friendId);

        let total = 0;
        if (progressData) {
            progressData.forEach(entry => {
                if (entry.date_key && entry.date_key.startsWith('anki-')) return;
                const q = parseInt(entry.questions || 0);
                if (!isNaN(q) && q >= 0) total += q;
            });
        }

        // Build HTML for this friend card
        const cardHTML = `
            <div class="friend-item">
                <div class="friend-info">
                    <div class="avatar">${name[0].toUpperCase()}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1.1rem;">${name}</div>
                        <div class="progress-mini">${total} / 4088 questions ‚Ä¢ ${Math.round(total / 4088 * 100)}%</div>
                    </div>
                </div>
                <div class="friend-actions">
                    <button class="btn btn-primary btn-small" onclick="viewFriendProgress('${friendId}', '${name}')">View Progress</button>
                    <button class="btn btn-danger btn-small" onclick="removeFriend('${friendId}')">Remove</button>
                </div>
            </div>
        `;
        friendCards.push(cardHTML);
    }

    // Update DOM once with all cards (prevents flickering)
    container.innerHTML = friendCards.join('');

    // Populate the Friend Watch dropdown on dashboard
    populateFriendWatchDropdown(friendsList);
}

async function removeFriend(friendId) {
    if (!confirm('Remove this friend?')) return;

    // Remove friendship row where current user is the owner
    // (either user_id or was created by accepting their request)
    await supabase.from('friends').delete()
        .eq('user_id', currentUser.id)
        .eq('friend_id', friendId);

    // Also try the other direction (if they accepted your request)
    await supabase.from('friends').delete()
        .eq('user_id', friendId)
        .eq('friend_id', currentUser.id);

    loadFriends();
}

async function viewFriendProgress(friendId, friendName) {
    console.log('Viewing friend progress:', friendId, friendName);

    viewingFriendId = friendId;
    viewingFriendName = friendName;

    // Save viewing state to localStorage
    localStorage.setItem('viewingFriendId', friendId);
    localStorage.setItem('viewingFriendName', friendName);

    // Show viewing banner
    document.getElementById('viewing-banner').style.display = 'block';
    document.getElementById('viewing-name').textContent = friendName;

    // Switch to tracker tab first
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector('.tab').classList.add('active'); // My Tracker tab
    document.getElementById('tracker-tab').classList.add('active');

    // Load friend's progress FIRST
    await loadProgress();

    // Then render with friend's data
    console.log('Friend data loaded, rendering...', Object.keys(userProgress).length, 'entries');
    render();
    updateStats();
    loadAnkiState();
}

function returnToMyProgress() {
    console.log('Returning to my progress');

    viewingFriendId = null;
    viewingFriendName = null;

    // Clear viewing state from localStorage
    localStorage.removeItem('viewingFriendId');
    localStorage.removeItem('viewingFriendName');

    // Hide viewing banner
    document.getElementById('viewing-banner').style.display = 'none';

    // INSTANTLY show cached progress for smooth UX
    if (Object.keys(myProgressCache).length > 0) {
        userProgress = { ...myProgressCache };
        render(); // Render immediately with cached data
        loadAnkiState();
    }

    // Then reload fresh data in background
    loadProgress().then(() => {
        render(); // Re-render with fresh data
        loadAnkiState();
    });
}

async function loadLeaderboard() {
    const container = document.getElementById('leaderboard-list');

    // Show loading state immediately
    container.innerHTML = '<div class="empty-state">‚è≥ Loading leaderboard...</div>';

    // Get friend IDs from both directions
    const { data: friendships1 } = await supabase
        .from('friends')
        .select('friend_id')
        .eq('user_id', currentUser.id);

    const { data: friendships2 } = await supabase
        .from('friends')
        .select('user_id')
        .eq('friend_id', currentUser.id);

    const friendIdsSet = new Set();

    if (friendships1) {
        friendships1.forEach(f => friendIdsSet.add(f.friend_id));
    }

    if (friendships2) {
        friendships2.forEach(f => friendIdsSet.add(f.user_id));
    }

    const friendIds = Array.from(friendIdsSet);
    friendIds.push(currentUser.id); // Include current user

    console.log('‚ö° Loading leaderboard for', friendIds.length, 'users in parallel...');

    // Load all users' data in parallel for SPEED
    const leaderboardPromises = friendIds.map(async (userId) => {
        // Get user data and progress in parallel
        const [userResult, progressResult] = await Promise.all([
            supabase.from('users').select('name').eq('id', userId).single(),
            supabase.from('progress').select('questions, date_key').eq('user_id', userId)
        ]);

        const userData = userResult.data;
        const progressData = progressResult.data;

        let total = 0;
        if (progressData) {
            progressData.forEach(entry => {
                if (entry.date_key && entry.date_key.startsWith('anki-')) return;
                const q = parseInt(entry.questions || 0);
                if (!isNaN(q) && q >= 0) total += q;
            });
        }

        return {
            id: userId,
            name: userData?.name || 'User',
            total: total,
            isMe: userId === currentUser.id
        };
    });

    // Wait for all to complete
    const leaderboard = await Promise.all(leaderboardPromises);
    console.log('‚úÖ Leaderboard loaded instantly!');

    leaderboard.sort((a, b) => b.total - a.total);

    // Build all leaderboard items at once (prevents flickering)
    const leaderboardHTML = leaderboard.map((user, index) => `
        <div class="leaderboard-item" style="${user.isMe ? 'border-color: var(--accent);' : ''}">
            <div class="rank">#${index + 1}</div>
            <div class="friend-info">
                <div class="avatar">${user.name[0].toUpperCase()}</div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; font-size: 1.1rem;">${user.name}${user.isMe ? ' (You)' : ''}</div>
                    <div class="progress-mini">${Math.round(user.total / 4088 * 100)}% complete</div>
                </div>
            </div>
            <div style="font-size: 2rem; font-weight: bold; color: var(--accent); text-align: center; margin-top: 8px;">${user.total} Qs</div>
        </div>
    `).join('');

    // Update DOM once
    container.innerHTML = leaderboardHTML || '<div class="empty-state">Add friends to see the leaderboard!</div>';
}

// Close modal on outside click
document.getElementById('day-modal').addEventListener('click', (e) => {
    if (e.target.id === 'day-modal') closeModal();
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});

document.getElementById('questions-input')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        saveEntry();
    }
});
</script>

</body>
</html>
